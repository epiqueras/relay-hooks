import{__internal as e,createOperationDescriptor as t,getRequest as n,createRequestDescriptor as r,createReaderSelector as o,ConnectionInterface as i,isPromise as s,Observable as a,getVariablesFromFragment as u,getDataIDsFromFragment as c,getFragment as l,getSelector as f,commitMutation as h,requestSubscription as p}from"relay-runtime";export{applyOptimisticMutation,commitLocalUpdate,commitMutation,fetchQuery,graphql,requestSubscription}from"relay-runtime";import d,{useState as b,useRef as g,useEffect as m,useMemo as v,useCallback as y}from"react";import _ from"fbjs/lib/areEqual";import R from"fbjs/lib/invariant";import w from"fbjs/lib/warning";import C from"@restart/hooks/useMounted";var k=(0,e.createRelayContext)(d),S=function(){return(S=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},F="network-only",P="store-and-network",q="store-or-network",x="store-only",E="forward",D=function(e,t){return"network-only"===e||"store-and-network"===e||"store-or-network"===e&&!t},U=function(e){return"network-only"!==e};function A(e,r){return t(n(e),r)}function V(e){return"function"==typeof e?{error:e,complete:e,unsubscribe:function(t){"function"==typeof e&&e()}}:e||{}}function Q(e,t){if(!e){var n=function(e){var t=null,n=!1,r=e.metadata&&e.metadata.connection;return void 0!==e.metadata&&(n=!0),r&&(R(1===r.length,"ReactRelayPaginationContainer: Only a single @connection is supported, `%s` has %s.",e.name,r.length),R(!t,"ReactRelayPaginationContainer: Only a single fragment with @connection is supported."),t=S(S({},r[0]),{fragmentName:e.name})),R(!n||null!==t,"ReactRelayPaginationContainer: A @connection directive must be present."),t||{}}(t),r=function(e){var t=e.path;return R(t,"ReactRelayPaginationContainer: Unable to synthesize a getConnectionFromProps function."),function(e){for(var n=e,r=0;r<t.length;r++){if(!n||"object"!=typeof n)return null;n=n[t[r]]}return n}}(n),o=n.direction;return R(o,"ReactRelayPaginationContainer: Unable to infer direction of the connection, possibly because both first and last are provided."),{direction:o,getConnectionFromProps:r,getFragmentVariables:function(e){var t=e.count;return R(t,"ReactRelayPaginationContainer: Unable to synthesize a getFragmentVariables function."),function(e,n){var r;return S(S({},e),((r={})[t]=n,r))}}(n)}}return e}function O(e,t,n){if(_(n,t.variables))return t;var i=r(e,n);return o(t.node,t.dataID,n,i)}function j(e,t,n){var r=e.direction,o=(n&&n.getConnectionFromProps?n.getConnectionFromProps:e.getConnectionFromProps)(t);if(null==o)return null;var s=i.get(),a=s.EDGES,u=s.PAGE_INFO,c=s.HAS_NEXT_PAGE,l=s.HAS_PREV_PAGE,f=s.END_CURSOR,h=s.START_CURSOR;R("object"==typeof o,"ReactRelayPaginationContainer: Expected `getConnectionFromProps()` in `%s`to return `null` or a plain object with %s and %s properties, got `%s`.","useFragment pagination",a,u,o);var p=o[a],d=o[u];if(null==p||null==d)return null;R(Array.isArray(p),"ReactRelayPaginationContainer: Expected `getConnectionFromProps()` in `%s`to return an object with %s: Array, got `%s`.","useFragment pagination",a,p),R("object"==typeof d,"ReactRelayPaginationContainer: Expected `getConnectionFromProps()` in `%s`to return an object with %s: Object, got `%s`.","useFragment pagination",u,d);var b="forward"===r?d[c]:d[l],g="forward"===r?d[f]:d[h];return"boolean"!=typeof b||0!==p.length&&void 0===g?(w(!1,"ReactRelayPaginationContainer: Cannot paginate without %s fields in `%s`. Be sure to fetch %s (got `%s`) and %s (got `%s`).",u,"useFragment pagination","forward"===r?c:l,b,"forward"===r?f:h,g),null):{cursor:g,edgeCount:p.length,hasMore:b}}var M=e.fetchQuery,T=new Map;function I(e,t){var n=!!e,r=n&&T.has(e.request.identifier)?T.get(e.request.identifier):new L(n,n);return r.setForceUpdate(t),r}var L=function(){function e(e,t){void 0===e&&(e=!1),void 0===t&&(t=!1),this.suspense=e,this.useLazy=e&&t,this.setForceUpdate((function(){}))}return e.prototype.setForceUpdate=function(e){this.forceUpdate=e},e.prototype.dispose=function(){this.disposeRequest(),this.disposeRetain()},e.prototype.disposeRetain=function(){this.clearTemporaryRetain(),this.disposableRetain&&this.disposableRetain.dispose(),this.query&&T.delete(this.query.request.identifier)},e.prototype.clearTemporaryRetain=function(){clearTimeout(this.releaseQueryTimeout),this.releaseQueryTimeout=null},e.prototype.temporaryRetain=function(){var e=this;this.releaseQueryTimeout=setTimeout((function(){e.dispose()}),3e4)},e.prototype.isDiffEnvQuery=function(e,t){return e!==this.environment||t.request.identifier!==this.query.request.identifier},e.prototype.lookupInStore=function(e,t,n){if(U(n)){var r=e.check(t);if("available"===r||"available"===r.status)return e.lookup(t.fragment)}return null},e.prototype.execute=function(e,t,n,r){var o=this;void 0===r&&(r=function(e,t){return e.retain(t)});var i,s=n.fetchPolicy,a=void 0===s?"store-or-network":s,u=n.networkCacheConfig,c=n.fetchKey,l=n.fetchObserver,f=function(e,t){void 0===e&&(e=u),o.disposeRequest(),o.fetch(e,!1,t)};if(n.skip)return{cached:!1,retry:f,error:null,props:void 0};this.clearTemporaryRetain();var h=this.isDiffEnvQuery(e,t);(h||a!==this.fetchPolicy||c!==this.fetchKey)&&(h&&(this.disposeRetain(),this.useLazy&&T.set(t.request.identifier,this),this.disposableRetain=r(e,t)),this.environment=e,this.query=t,this.fetchPolicy=a,this.fetchKey=c,this.disposeRequest(),i=this.lookupInStore(e,this.query,a),D(a,i)?this.fetch(u,this.suspense&&!i,l):i&&(this.snapshot=i,this.error=null,this.subscribe(i)));var p=i||this.snapshot;return{cached:!!i,retry:f,error:this.error,props:p?p.data:null}},e.prototype.subscribe=function(e){var t=this;this.rootSubscription&&this.rootSubscription.dispose(),this.rootSubscription=this.environment.subscribe(e,(function(e){t.snapshot=e,t.error=null,t.forceUpdate(e)}))},e.prototype.fetch=function(e,t,n){var r=this;void 0===n&&(n={});var o=!1,i=function(){};if(M(this.environment,this.query,{networkCacheConfig:t&&!e?{force:!0}:e}).subscribe({start:function(e){r.networkSubscription={dispose:function(){return e.unsubscribe()}},n.start&&n.start(e)},next:function(){r.error=null,r._onQueryDataAvailable({notifyFirstResult:o,suspense:t,observer:n}),i()},error:function(e){r.error=e,r.snapshot=null,o&&!t&&r.forceUpdate(e),i(),r.networkSubscription=null,n.error&&n.error(e)},complete:function(){r.networkSubscription=null,n.complete&&n.complete()},unsubscribe:function(e){r.useLazy&&!r.rootSubscription&&r.releaseQueryTimeout&&r.dispose(),n.unsubscribe&&n.unsubscribe(e)}}),o=!0,t)throw this.useLazy&&(this.setForceUpdate((function(){})),this.temporaryRetain()),new Promise((function(e){i=e}))},e.prototype.disposeRequest=function(){this.error=null,this.snapshot=null,this.networkSubscription&&(this.networkSubscription.dispose(),this.networkSubscription=null),this.rootSubscription&&(this.rootSubscription.dispose(),this.rootSubscription=null)},e.prototype._onQueryDataAvailable=function(e){var t=e.notifyFirstResult,n=e.suspense,r=e.observer;this.snapshot||(this.snapshot=this.environment.lookup(this.query.fragment),this.subscribe(this.snapshot),r.next&&r.next(this.snapshot),this.snapshot&&t&&!n&&this.forceUpdate(this.snapshot))},e}(),H=function(e){var t=b(null)[1],n=g();return null==n.current&&(n.current={queryFetcher:I(e,t)}),m((function(){return function(){return n.current.queryFetcher.dispose()}}),[]),n.current.queryFetcher};function N(){return d.useContext(k).environment}function z(e,t){var n,r,o=(r=g(n=t),_(r.current,n)||(r.current=n),r.current);return v((function(){return A(e,o)}),[e,o])}var G=function(e,t,n){void 0===t&&(t={}),void 0===n&&(n={});var r=N(),o=z(e,t);return H().execute(r,o,n)},K=function(e,t,n){void 0===t&&(t={}),void 0===n&&(n={});var r=N(),o=z(e,t);return H(o).execute(r,o,n)},B=function(e,t){void 0===e&&(e=!1),void 0===t&&(t=function(e,t,n,r,o){return e.execute(t,n,r,o)});var n=null,r=void 0,o=new L(!0),i={environment:null,gqlQuery:null,variables:null,options:null,query:null},a=function(s,a,u,c){void 0===u&&(u={}),void 0===c&&(c={}),i.environment=s,i.options=c,_(u,i.variables)&&a==i.gqlQuery||(i.variables=u,i.gqlQuery=a,i.query=A(a,i.variables));var l,f=function(){n=t(o,i.environment,i.query,i.options),r&&r(n)};o.setForceUpdate(f);try{f()}catch(t){l=t.then(f),e?n=l:f()}return null!=l?l:Promise.resolve()};return{next:a,subscribe:function(e){return r=e,function(){r===e&&(r=null)}},getValue:function(e){if(e&&e!=i.environment&&a(e,i.gqlQuery,i.variables,i.options),s(n))throw n;return n},dispose:function(){o.dispose(),o=new L(!0),r=void 0,n=null,i={environment:null,gqlQuery:null,variables:null,options:null,query:null}}}},X=function(){return B(!0)},J=function(){return B(!1)},W=function(e){var t=b()[1],n=N();return m((function(){var n=e.subscribe(t);return function(){return n()}}),[e]),e.getValue(n)},Y=e.fetchQuery;function Z(e){return Array.isArray(e)?{snapshot:e,data:e.map((function(e){return e.data}))}:{snapshot:e,data:e.data}}var $=function(){function e(e){var t=this;this._disposable={dispose:function(){}},this._isARequestInFlight=!1,this._selectionReferences=[],this.indexUpdate=0,this.refetch=function(e,n,r,o,i){var s=t.getFragmentVariables(),a="function"==typeof n?n(s):n,u=r?S(S({},a),r):a;return t.executeFetcher(e,a,i,"function"==typeof o?{next:o,error:o}:o||{},(function(e,n,r){t.changeVariables(u,e.request.node),t.refreshHooks(),r()}))},this.isLoading=function(){return!!t._refetchSubscription},this.hasMore=function(e){t.paginationData=Q(t.paginationData,t._fragment);var n=j(t.paginationData,t.getData(),e);return!!(n&&n.hasMore&&n.cursor)},this.refetchConnection=function(e,n,r,o){return t.paginationData=Q(t.paginationData,t._fragment),t._refetchVariables=o,t._fetchPage(e,{count:n,cursor:null,totalCount:n},V(r),{force:!0})},this.loadMore=function(e,n,r,o){t.paginationData=Q(t.paginationData,t._fragment);var i=V(r),s=j(t.paginationData,t.getData(),e);if(!s)return a.create((function(e){return e.complete()})).subscribe(i),null;var u=s.edgeCount+n;return o&&o.force?t.refetchConnection(e,u,r,void 0):t._fetchPage(e,{count:n,cursor:s.cursor,totalCount:u},i,o)},this._forceUpdate=e}return e.prototype.refreshHooks=function(){this.indexUpdate+=1,this._forceUpdate(this.indexUpdate)},e.prototype.dispose=function(){this._disposable&&this._disposable.dispose(),this._refetchSubscription&&this._refetchSubscription.unsubscribe(),this._refetchSubscription=null,this.disposeSelectionReferences(),this._isARequestInFlight=!1},e.prototype.disposeSelectionReferences=function(){this._disposeCacheSelectionReference(),this._selectionReferences.forEach((function(e){return e.dispose()})),this._selectionReferences=[]},e.prototype._retainCachedOperation=function(e){this._disposeCacheSelectionReference(),this._cacheSelectionReference=this._environment.retain(e)},e.prototype._disposeCacheSelectionReference=function(){this._cacheSelectionReference&&this._cacheSelectionReference.dispose(),this._cacheSelectionReference=null},e.prototype.getFragmentVariables=function(e){return void 0===e&&(e=this._fragmentRef),u(this._fragment,e)},e.prototype.changedFragmentRef=function(e){if(this._fragmentRef!==e){var t=c(this._fragment,this._fragmentRef),n=c(this._fragment,e);if(!_(t,n)||!_(this.getFragmentVariables(e),this.getFragmentVariables(this._fragmentRef)))return!0}return!1},e.prototype.resolve=function(e,t,n){this._fragmentNode!==t&&(this._fragment=l(t),this.paginationData=null),(this._environment!==e||this._fragmentNode!==t||this.changedFragmentRef(n))&&(this._environment=e,this._fragmentNode=t,this._fragmentRef=n,this._result=null,this.dispose(),null==this._fragmentRef&&(this._result={data:null,snapshot:null}),this._isPlural=this._fragment.metadata&&this._fragment.metadata.plural&&!0===this._fragment.metadata.plural,this._isPlural&&0===this._fragmentRef.length&&(this._result={data:[],snapshot:[]}),this._result||(this._selector=f(this._fragment,this._fragmentRef),this.lookup()))},e.prototype.lookup=function(){var e,t,n=(e=this._environment,"PluralReaderSelector"===(t=this._selector).kind?t.selectors.map((function(t){return e.lookup(t)})):e.lookup(t));this._result=Z(n),this.subscribe()},e.prototype.getData=function(){return this._result?this._result.data:null},e.prototype.subscribe=function(){var e=this,t=this._environment,n=this._result.snapshot;this._disposable&&this._disposable.dispose(),n||(this._disposable={dispose:function(){}});var r=[];Array.isArray(n)?n.forEach((function(n,o){r.push(t.subscribe(n,(function(t){e._result.snapshot[o]=t,e._result.data[o]=t.data,e.refreshHooks()})))})):r.push(t.subscribe(n,(function(t){e._result=Z(t),e.refreshHooks()}))),this._disposable={dispose:function(){r.map((function(e){return e.dispose()}))}}},e.prototype.changeVariables=function(e,t){"PluralReaderSelector"===this._selector.kind?this._selector.selectors=this._selector.selectors.map((function(n){return O(t,n,e)})):this._selector=O(t,this._selector,e),this.lookup()},e.prototype.lookupInStore=function(e,t,n){if(U(n)){var r=e.check(t);if("available"===r||"available"===r.status)return this._retainCachedOperation(t),e.lookup(t.fragment)}return null},e.prototype._fetchPage=function(e,t,n,r){var o,i=this,s=null!=(o=this._selector)&&"PluralReaderSelector"===o.kind?o.selectors[0]?o.selectors[0].owner.variables:{}:o?o.owner.variables:{},a=S(S(S({},s),this.getFragmentVariables()),this._refetchVariables),u=e.getVariables(this.getData(),{count:t.count,cursor:t.cursor},a);return R("object"==typeof u&&null!==u,"ReactRelayPaginationContainer: Expected `getVariables()` to return an object, got `%s` in `%s`.",u,"useFragment pagination"),u=S(S({},u),this._refetchVariables),a=S(S({},u),a),this.executeFetcher(e.query,u,r,n,(function(n,r,o){var s=i.getData();i.changeVariables((e.getFragmentVariables||i.paginationData.getFragmentVariables)(a,t.totalCount),n.request.node);var u,c,l,f=i.getData();_(s,f)?o():(i.refreshHooks(),u=i,l=function(){return function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}(this,(function(e){return o(),[2]}))},new((c=void 0)||(c=Promise))((function(e,t){function n(e){try{o(l.next(e))}catch(e){t(e)}}function r(e){try{o(l.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new c((function(e){e(t.value)})).then(n,r)}o((l=l.apply(u,[])).next())})))}))},e.prototype.executeFetcher=function(e,t,n,r,o){var i=this,s=n?{force:!!n.force}:void 0;null!=s&&n&&null!=n.metadata&&(s.metadata=n.metadata);var u,c="function"==typeof r?{next:r,error:r}:r||{},l=A(e,t),f=(n||{}).fetchPolicy,h=void 0===f?"network-only":f,p=this.lookupInStore(this._environment,l,h);null!=p&&o(l,null,(function(){c.next&&c.next(),c.complete&&c.complete()})),this._refetchSubscription&&this._refetchSubscription.unsubscribe();var d=D(h,p);if(!d)return{dispose:function(){}};if(d){var b=this._environment.retain(l),g=null!=s?{networkCacheConfig:s}:{},m=function(){i._selectionReferences=i._selectionReferences.concat(b),i._refetchSubscription===u&&(i._refetchSubscription=null,i._isARequestInFlight=!1)};this._isARequestInFlight=!0,Y(this._environment,l,g).mergeMap((function(e){return a.create((function(t){o(l,e,(function(){t.next(void 0),t.complete()}))}))})).do({error:m,complete:m,unsubscribe:m}).subscribe(S(S({},c),{start:function(e){u=e,i._refetchSubscription=i._isARequestInFlight?u:null,c.start&&c.start(e)}}))}return{dispose:function(){u&&u.unsubscribe()}}},e}();function ee(e,t){var n=N(),r=b(null)[1],o=g(null);null==o.current&&(o.current={resolver:new $(r)});var i=o.current.resolver;return m((function(){return function(){i.dispose()}}),[i]),i.resolve(n,e,t),[i.getData(),i]}function te(e,t){return ee(e,t)[0]}var ne=d.useCallback,re=d.useState;function oe(e,t,n){void 0===t&&(t={});var r=re({loading:!1,data:null,error:null}),o=r[0],i=r[1],s=C(),a=N(),u=n||a,c=t.configs,l=t.variables,f=t.uploadables,p=t.onCompleted,d=t.onError,b=t.optimisticUpdater,g=t.optimisticResponse,m=t.updater;return[ne((function(t){var n=S({configs:c,variables:l,uploadables:f,onCompleted:p,onError:d,optimisticUpdater:b,optimisticResponse:g,updater:m},t);return R(n.variables,"you must specify variables"),i({loading:!0,data:null,error:null}),new Promise((function(t,r){function o(e){s()&&i({loading:!1,data:null,error:e}),n.onError?(n.onError(e),t()):r(e)}h(u,S(S({},n),{mutation:e,variables:n.variables,onCompleted:function(e,r){r?o(r):(s()&&i({loading:!1,data:e,error:null}),n.onCompleted&&n.onCompleted(e),t(e))},onError:o}))}))}),[u,c,e,l,f,p,d,b,g,m,s]),o]}function ie(e){var t=N();m((function(){return p(t,e).dispose}),[t,e])}function se(e,t){var n=ee(e,t),r=n[1];return[n[0],v((function(){return{loadMore:r.loadMore,hasMore:r.hasMore,isLoading:r.isLoading,refetchConnection:r.refetchConnection}}),[r])]}function ae(e,t){var n=ee(e,t);return[n[0],n[1].refetch]}function ue(e,t){var n=ae(e,t),r=n[0],o=n[1],i=v((function(){var t=l(e),n=t.metadata;R(null!=n,"useRefetchable: Expected fragment `%s` to be refetchable when using `%s`. Did you forget to add a @refetchable directive to the fragment?","useRefetchable",t.name),R(!0!==n.plural,"useRefetchable: Expected fragment `%s` not to be plural when using `%s`. Remove `@relay(plural: true)` from fragment `%s` in order to use it with `%s`.",t.name,"useRefetchable",t.name,"useRefetchable");var r=n.refetch;return R(null!=r,"useRefetchable: Expected fragment `%s` to be refetchable when using `%s`. Did you forget to add a @refetchable directive to the fragment?","useRefetchable",t.name),r.operation.default?r.operation.default:r.operation}),[e]);return[r,y((function(e,t){return void 0===t&&(t={}),o(i,e,t.renderVariables,t.observerOrCallback,t.refetchOptions)}),[o,i])]}var ce=function(e){var t=d.useMemo((function(){return{environment:e.environment}}),[e.environment]);return d.createElement(k.Provider,{value:t},e.children)};export{E as FORWARD,F as NETWORK_ONLY,k as ReactRelayContext,ce as RelayEnvironmentProvider,x as STORE_ONLY,q as STORE_OR_NETWORK,P as STORE_THEN_NETWORK,X as loadLazyQuery,J as loadQuery,te as useFragment,K as useLazyLoadQuery,oe as useMutation,ee as useOssFragment,se as usePagination,W as usePreloadedQuery,G as useQuery,H as useQueryFetcher,ae as useRefetch,ue as useRefetchable,N as useRelayEnvironment,ie as useSubscription};
//# sourceMappingURL=es-relay-hooks.min.js.map
